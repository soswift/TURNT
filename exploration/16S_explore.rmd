---
title: "TURNT-16S exploration"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    smooth_scroll: true 
    fig_width: 10
    code_folding: hide 
date: "`r Sys.Date()`"
---


# Overview
This rmarkdown explores the fDOM data associated with the Mo'orea 2021 Turbinaria nutrient addition (and remineralization) experiment: **TURNT**.

Pairs of Turbinaria individuals were placed in clear aquaria on a water table.



       



There were three treatments:

 C = **control**, collected at 'normal' reef site, no nutrient addition
 
 N = **nutrient**, collected at 'normal' reef site site, osmocote added during experiment 
 
 R = **recharge**, collected at long-term osmocote addition site, osmocote added during experiment 
 
 B = **blank**, emtpy aquaria containing filtered seawater water that were left out on water table during treatment
 
 
There were four data points collected:

 **exudation_1** = initial exudation after bringing Turbinaria in from the collection site (post 24hr acclimation period)
 
 **exudation_2** = exudation after 4 days of treatment
 
 **remin_T0** =  exudation 2 products pooled by treatment, mixed with reef water, and subsampled.
 
 **remin_TF** = remaining compounds after 24hr remineralization by microbes
 
 
Timeline: 
  Collection ->
  
    Acclimation (24hr) ->
    
      Exudation 1 (~10 hr) ->
      
       Treatment (4 days) ->
       
        Exudation 2 (~10 hr) ->
        
          Pool exudates by treatment ->
          
            T0 remin sampling ->
            
             Remineralization (24 hr) ->
             
              TF remin sampling
   

Purpose of this document:

  1) Organize the fDOM and sample data

  2) ordinate samples based on fDOM indices

  3) compare fDOM index values across treatments for each index


```{r}
library(data.table)
library(ggplot2)
library(vegan)
library(ComplexHeatmap)

set.seed(2020)

otu_file = "../data/16S/16S-pipeline_outputs/Results/main/abundance_table_100.csv"
unifrac_file = "../data/16S/16S-pipeline_outputs/Results/postprocessing/unifrac/unifrac_weighted_100.csv"
run_map_file = "../data/16S/2022-0018_16S amplicons.csv"
sample_meta_file = "../data/sample_data/TURNT_sample_sheet - DNA_tubes.csv"

otu_raw = fread(otu_file, sep = ",")
run_map = fread(run_map_file)
sample_meta = fread(sample_meta_file)

unifrac = read.csv(unifrac_file)

TURNT_samples = sample_meta$bead_tube

turnt_clrs = c(
  control = "#73d9f0",
  nutrient = "#f7b301",
  recharge = "#eb773e",
  blank = "gray",
  exudation_1 = "yellow2",
  exudation_2 = "yellow4",
  remin_T0 = "thistle1",
  remin_TF = "thistle3"
  )

theme_set(theme_minimal())

```

```{r}
# organizing data
# separate otu taxonomy from counts
tax_cols = c( "repSeqName", "repSeq", "OTUConTaxonomy")

otu = otu_raw[ , .SD, .SDcols = !tax_cols]


tax_raw = otu_raw[ , .SD, .SDcols = c("OTUNumber",tax_cols)]
tax = fread(text = tax_raw$OTUConTaxonomy, sep = ";")
names(tax) = c(
                "kingdom",
                "phylum",
                "class",
                "order",
                "family",
                "genus",
                "species"
)
tax[ , species := NULL]
tax[ , OTUNumber := tax_raw$OTUNumber]

# drop non-TURNT samples
keep_cols = names(otu)[names(otu) %in% TURNT_samples]
otu = otu[ , .SD, .SDcols = c("OTUNumber",keep_cols)]

# drop empty otus
drop_otus = rowSums(otu[ , -1]) > 0
otu = otu[drop_otus,]

# transpose otu table so samples are rows
t_otu = transpose(otu, keep.names = "bead_tube", make.names = "OTUNumber")


# clean unifrac distances and store as matrix
row.names(unifrac) = unifrac$X
unifrac = unifrac[ , colnames(unifrac) != "X"]
colnames(unifrac) = gsub("X(.+)", "\\1", colnames(unifrac))

all_d = unifrac[row.names(unifrac) %in% TURNT_samples, 
                  colnames(unifrac) %in% TURNT_samples]
  


# merge sample meta and run map
setnames(run_map, "Sample Name", "bead_tube")
run_map[ , bead_tube := sub(" ","_", bead_tube)]

all_meta = merge(sample_meta, run_map, by = "bead_tube", all.x = T)

```

```{r}
# QC the run
# check which samples made it through the pipeline
meta = all_meta[bead_tube %in% row.names(all_d)]
bad_meta = all_meta[!(bead_tube %in% meta$bead_tube)]

# bad meta == all the tissue samples


```

# Ordination

To start, we'll run some NMDS ordinations. First, ordinating all samples together, then by each stage of the experiment. I'm using both unifrac distances (generated for all samples by the metaflowmics pipeline) and bray curtis distances (generated by vegdist for each data subset).



```{r}
# ordination function
ord_uni = function(dist_mat){
  ord = metaMDS(comm = as.dist(dist_mat))
  out = list(points = as.data.table(ord$points, keep.rownames = "bead_tube"),
             stress = round(ord$stress, 3))
  return(out) 
}

ord_bray = function(otu_dt){
  
  otu_mat = as.matrix(otu_dt[ , .SD, .SDcols = !"bead_tube"])
  row.names(otu_mat) = otu_dt$bead_tube
  
  ord = metaMDS(comm = otu_mat, distance = "bray")
  out = list(points = as.data.table(ord$points, keep.rownames = "bead_tube"),
             stress = round(ord$stress, 3))
  return(out) 
}

plot_ord = function(ord_out, p_title= NULL, color_var){
 points = ord_out$points
 ord_meta = merge(points, meta, by = "bead_tube")
 
 p_colors = turnt_clrs[names(turnt_clrs) %in% unique(meta[[color_var]])]
 
  
 ggplot(ord_meta, aes_string(x = "MDS1", y = "MDS2", color = color_var))+
   geom_point(size = 3)+
   scale_color_manual(values = p_colors)+
   labs(title = p_title, 
        caption = paste("Stress =", ord_out$stress))
}

```

## All samples

Ordinating all the samples together, we see clear separation between the different stages of the experiment. At this level, it's hard to see differences between the treatments within each stage. 

We expect microbial communities to vary quite a bit between experimental stages. Exudations were performed on pairs of turbinaria prior to nutrient treatment and post nutrient treatment. Remineralizations were pseudoreplicates of the same microbial community exposed to different algal exudates. I'd guess remin samples would be much more tightly clustered than the exudation samples and pretty distinct, compositionally. And that's what we see.


```{r  include=FALSE}
# ordinate all samples
# unifrac
all_ord_uni = ord_uni(all_d)
# bray
all_ord_bray = ord_bray(t_otu)


```

```{r}
plot_ord(all_ord_uni,
         "All samples - unifrac",
         color_var = "stage")
plot_ord(all_ord_uni,
         "All samples - unifrac",
         color_var = "treatment")


plot_ord(all_ord_bray,
         "All samples - bray",
         color_var = "stage")
plot_ord(all_ord_bray,
         "All samples - bray",
         color_var = "treatment")
```



```{r, include=FALSE}
# ordinate each stage

do_ordinations = function(a_stage, sample_meta = meta){

  samps = sample_meta[stage %in% a_stage, bead_tube]
  
  
  stage_d = all_d[samps, samps]
  uni_ord = ord_uni(stage_d)
  uni_plot = plot_ord(uni_ord,
                      paste(paste(a_stage), "- unifrac"),
                      "treatment")
  
  
  stage_otus = t_otu[bead_tube %in% samps]
  bray_ord = ord_bray(stage_otus)
  bray_plot = plot_ord(bray_ord,
                       paste(paste(a_stage), "- bray"),
                       "treatment")
  
  return(
    list(
      samps = samps,
      uni_ord = uni_ord,
      uni_plot = uni_plot,
      bray_ord = bray_ord,
      bray_plot = bray_plot
      )
  )
}

# run on each stage
stages = unique(meta$stage)
all_ords = lapply( stages, do_ordinations)
names(all_ords) = stages

```

## Exudations

The 'exudation' microbes are whatever microbes managed to sneak into our filtered water during the two 10 hr exudations. We definitely expect to see a difference between the 'blanks' and all other samples. Blanks are just empty aquaria with filtered water. They shouldn't have a lot going on microbially.

Prior to **exudation 1**, all of the turbinaria individuals were acclimating to captivity in the same big blue tub. We rinsed each individual with filtered water prior to exudation, but I'd still expect some random variation in the microbes that were present on each individual. Microbes splashing or falling into the aquaria are another source of random variation. 

Prior to **exudation 2**, turbinaria had been marinating in 3 separate flow through containers for 4 days with different nutrient treatments. We might see some separation by treatment in the exudation 2 microbes. If microbes were carried on the surface of the turbinaria into the exudation aquaria, then maybe samples from the same treatment (and thus the same treatment aquarium) would be more similar. Could also be that the differences in exudates between treatments are strong enough to drive a shift in random microbes during the exudation period. Not sure if any of this is super informative.

### Exudation 1

As expected real samples cluster together, blanks separate out. Differences between samples are random at this stage.

```{r}
all_ords$exudation_1$uni_plot

ggsave("plots/16S/exudation1_ord.png",
       plot = all_ords$exudation_1$uni_plot,
       width = 7, height = 6)

all_ords$exudation_1$bray_plot


```

### Exudation 2

This looks kind of messy. Blanks mostly separate out, but a control sample and two nutrient samples group with the blanks. One blank sample looks like an outlier. Should probably drop that and re-ordinate. Even if I do that, I don't see any clear treatment level patterns.

```{r}
all_ords$exudation_2$uni_plot

all_ords$exudation_2$bray_plot


```

## Remineralizations

Microbial data from the remineralizations should be interesting. This is a stage where we expect to see shifts in the microbial community. Remin T0 starts with the same microbial community, so all samples should be very similar. 



### Remin T0
This is the begining of the remineralization stage of the experiment. 

Initial observation: control sample 39_T is a clear outlier here. Not sure what's going on in that sample, but it throws off the ordination. I dropped 39_T and re-ran 

```{r}
all_ords$remin_T0$uni_plot + geom_text(aes(label = bead_tube), vjust = 2)

all_ords$remin_T0$bray_plot+ geom_text(aes(label = bead_tube), vjust = 2)
```

Here are the ordinations again with the outlier removed. Looks good to me. They aren't super different from each other and they are sort of mixed together. Given that they all have the same microbial community spiked in, that seems appropriate. Samples still kind of group together by treatment, but that's not totally unexpected. They are pseudoreplicates after all. 

```{r, include=FALSE}
clean_meta = meta[bead_tube != "39_T"]
clean_remin_T0 = do_ordinations("remin_T0", sample_meta = clean_meta)
```


```{r}
clean_remin_T0$uni_plot

ggsave("plots/16S/remin_t0_ord.png",
       plot =clean_remin_T0$uni_plot,
       width = 7, height = 6)

clean_remin_T0$bray_plot

```

## Remin TF

This is where we want to see some sort of intelligble pattern separating the treatments. The wild microbial community was given 4 types of food: 
- control exudates (no nutrient addition)
- recharge exudates (long term nutrient addition)
- nutrient exudates (short term nutrient addition)
- blank (just water, no food)

Do the different food sources shift the microbial community in a consistent way or does it not matter?

Looks like yes. Adding turbinaria exudates caused microbial communities to shift away from the blanks. The nutrient treatment was the most different from the blanks, followed by recharge, with controls being the least different and most variable. All three samples from the nutrient treatment are highly similar, which is cool. Looks like they all ended up with the same community, which supports the idea that the exudates were actually driving community composition. I think this tracks with the flow cytometry data, too (but that's for later).  

```{r}
all_ords$remin_TF$uni_plot

all_ords$remin_TF$bray_plot
```

### Remin Track Changes

Last thing  to look at: How do the individual pseudoreplicates track from remin T0 to remin TF? This is probably the best plot. The remin T0s all start off very similar to each other. The remin TF samples are all shifted in the same direction. Blanks shift the least and have the widest spread. 'Control' samples shift more, but have some variation. Remin samples are tightly clustered and shifted even further. 'Nutrient' samples are shifted the furthest and are very tightly clustered. 

In other words, 24 hours in a bottle has a strong effect on the microbial community. Adding turbinaria exudates further shifts the community. Adding exudates from turbinaria that were fed nutrients shifts the community even further. Adding turbinaria exudates from individuals that received a sudden spike in nutrients causes the strongest shift of all. 

```{r include=FALSE}
remins_ord = do_ordinations(c("remin_T0","remin_TF"), clean_meta)


```
```{r}
remins_ord$uni_plot + geom_point(aes(shape = stage), size = 5)+
                                   geom_line(aes(group = rep), arrow = arrow(angle = 10,
                                                                             length = unit(0.2, "inches"),
                                                                             type = "closed"),
                                             alpha = 0.7)
ggsave("plots/16S/remin_arrows_ord.png",
       height = 6, width = 7)

remins_ord$bray_plot + geom_point(aes(shape = stage), size = 5)+
                                   geom_line(aes(group = rep), arrow = arrow(angle = 10,
                                                                             length = unit(0.2, "inches"),
                                                                             type = "closed"),
                                             alpha = 0.7)

```


# Heatmaps
This is a work in progress. I'd like to see what microbes are different in the remin TF samples. This is just a placeholder graphic, for now. I'll probably sum relative abundance by family.

```{r}
# function to sum by family
sum_by_tax = function(otus,
                      tax_table,
                      tax_level = "family",
                      cutoff = 40){
  
  otu_key = merge(otus,
                    tax_table[, .SD, .SDcols = c(tax_level, "OTUNumber")],
                    by = "OTUNumber",
                    all.x = T)
  otu_key[, OTUNumber := NULL]
  
  # sum by tax level
  otu_sum = otu_key[, lapply(.SD, sum), by = tax_level]

  # order by most abundant taxa
  otu_sum[ , tax_sums := rowSums(otu_sum[ , .SD, .SDcols = !tax_level])]
  otu_sum = otu_sum[tax_sums > 0]
  otu_sum = otu_sum[order(tax_sums, decreasing = T)]
  otu_sum[ , tax_sums := NULL]
  
  return(otu_sum)
}

# generate heatmap
make_heatmap = function(otu_dt,
                        id_col,
                        col_labs,
                        row_labs = NULL,
                        scale_vals = F,
                        min_sam = 2){
  
 # transform to matrix
 otu_mat = as.matrix(otu_dt[ , .SD, .SDcols = !id_col])
 otu_mat = otu_mat[rowSums(otu_mat) > 0,]
 
 # count taxon occurrence 
 keep_tax = apply(otu_mat, 1, function(x) length(x[x>0]) > min_sam)
 otu_mat = otu_mat[keep_tax,]
 row_labs = row_labs[keep_tax]
 
 if(isTRUE(scale_vals)){
   otu_mat = t(scale(t(otu_mat)))
 }
 
 Heatmap(matrix = otu_mat,
         column_labels = col_labs,
         row_labels = row_labs)
}

```


```{r}
# make a heatmap of the remin TF taxa

tf_otu = otu[, .SD,
             .SDcols = c("OTUNumber",
                         meta[stage == "remin_TF",
                              bead_tube])] 

tf_labs = meta[match(colnames(tf_otu)[-1],bead_tube), rep] 

# by otu
make_heatmap(tf_otu, "OTUNumber",
             row_labs = NULL,
             col_labs = tf_labs)

make_heatmap(tf_otu, "OTUNumber",
             row_labs = NULL,
             col_labs = tf_labs,
             scale = T)

# by genus
tf_g_sum = sum_by_tax(tf_otu, tax, tax_level = "genus")


make_heatmap(tf_g_sum, "genus",
             col_labs = tf_labs,
             row_labs = tf_g_sum$genus,
             scale = T)

# by family
tf_fam_sum = sum_by_tax(tf_otu, tax, tax_level = "family")


fam_ht = make_heatmap(tf_fam_sum, "family",
             col_labs = tf_labs,
             row_labs = tf_fam_sum$family,
             scale = T)
show(fam_ht)

pdf("plots/16S/family_heatmap.pdf",
       height = 15,
       width = 7)
show(fam_ht)
dev.off()

png("plots/16S/family_heatmap.png",
       height = 10,
       width = 7,
       unit = "in",
       res = 300
    )
show(fam_ht)
dev.off()


```
## Specific families of copiotrophs


```{r}
# long format for ggplot
fam_sum_long = melt.data.table(
                                tf_fam_sum,
                                id.vars = "family",
                                variable.name = "bead_tube",
                                value.name = "rel_abund"
                              )

fam_sum_long = merge(fam_sum_long, clean_meta, by = "bead_tube")

f_list = c("Rhodobacteraceae",
           "Flavobacteriaceae",
           "Alteromonadaceae",
           "SAR116_clade",
           "AEGEAN-169_marine")

for(fam in f_list){
  p = ggplot(fam_sum_long[grepl(fam,family),],
         aes(x = treatment, y = rel_abund, 
             color = treatment))+
    stat_summary(fill = "gray45",
                 fun = mean,
                 geom = "point",
                 pch = 24, size = 3)+
    geom_jitter(pch = 19,
                size = 2,
                alpha = 0.7)+
    labs(title = fam, x = NULL, y = NULL)+
    xlim("blank","control","recharge","nutrient")+
    scale_color_manual(values = turnt_clrs)+
    theme(legend.position = "none")
  
  print(p)
  
  ggsave(paste0("plots/16S/box_",fam,".png"),
      width = 7,
      height = 6,
      scale = .4)
  
}

```

